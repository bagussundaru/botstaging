{% extends "base.html" %}

{% block title %}Alerts History - Trading Bot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-0">
            <i class="fas fa-bell me-2"></i>Alerts History
        </h2>
        <p class="text-muted">Monitor and analyze your trading alerts and notifications</p>
    </div>
</div>

<!-- Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-2">
                        <label for="date-from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date-from">
                    </div>
                    <div class="col-md-2">
                        <label for="date-to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date-to">
                    </div>
                    <div class="col-md-2">
                        <label for="alert-type" class="form-label">Alert Type</label>
                        <select class="form-select" id="alert-type">
                            <option value="">All Types</option>
                            <option value="trade_signal">Trade Signal</option>
                            <option value="position_opened">Position Opened</option>
                            <option value="position_closed">Position Closed</option>
                            <option value="stop_loss">Stop Loss</option>
                            <option value="take_profit">Take Profit</option>
                            <option value="error">Error</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="symbol-filter" class="form-label">Symbol</label>
                        <select class="form-select" id="symbol-filter">
                            <option value="">All Symbols</option>
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="severity-filter" class="form-label">Severity</label>
                        <select class="form-select" id="severity-filter">
                            <option value="">All Levels</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="apply-filters">
                            <i class="fas fa-filter me-2"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Alerts</h6>
                        <h3 class="mb-0" id="total-alerts">1,247</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bell fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Trade Signals</h6>
                        <h3 class="mb-0" id="trade-signals">892</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Warnings</h6>
                        <h3 class="mb-0" id="warning-alerts">156</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Errors</h6>
                        <h3 class="mb-0" id="error-alerts">23</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Recent Alerts
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="export-alerts">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="clear-alerts">
                        <i class="fas fa-trash me-2"></i>Clear All
                    </button>
                    <button class="btn btn-primary btn-sm" id="refresh-alerts">
                        <i class="fas fa-sync me-2"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="alerts-table">
                        <thead class="table-light">
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Symbol</th>
                                <th>Message</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alerts-tbody">
                            <!-- Alerts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <nav>
                    <ul class="pagination pagination-sm mb-0 justify-content-center" id="alerts-pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Alert Detail Modal -->
<div class="modal fade" id="alertDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alert Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Alert ID:</strong>
                        <p id="modal-alert-id" class="text-muted"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Timestamp:</strong>
                        <p id="modal-timestamp" class="text-muted"></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Type:</strong>
                        <p id="modal-type"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Symbol:</strong>
                        <p id="modal-symbol"></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Severity:</strong>
                        <p id="modal-severity"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <p id="modal-status"></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <strong>Message:</strong>
                        <p id="modal-message" class="text-muted"></p>
                    </div>
                </div>
                <div class="row" id="modal-trade-details" style="display: none;">
                    <div class="col-12">
                        <strong>Trade Details:</strong>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody id="modal-trade-table">
                                    <!-- Trade details will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="mark-as-read">Mark as Read</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('date-from').value = weekAgo.toISOString().split('T')[0];
    document.getElementById('date-to').value = today.toISOString().split('T')[0];
    
    // Load initial data
    loadAlerts();
    loadSummaryStats();
    
    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', function() {
        currentPage = 1;
        loadAlerts();
    });
    
    document.getElementById('refresh-alerts').addEventListener('click', function() {
        loadAlerts();
        loadSummaryStats();
    });
    
    document.getElementById('export-alerts').addEventListener('click', exportAlerts);
    document.getElementById('clear-alerts').addEventListener('click', clearAlerts);
    document.getElementById('mark-as-read').addEventListener('click', markAsRead);
});

function loadAlerts() {
    const filters = {
        date_from: document.getElementById('date-from').value,
        date_to: document.getElementById('date-to').value,
        alert_type: document.getElementById('alert-type').value,
        symbol: document.getElementById('symbol-filter').value,
        severity: document.getElementById('severity-filter').value,
        page: currentPage
    };
    
    currentFilters = filters;
    
    fetch('/api/alerts?' + new URLSearchParams(filters))
        .then(response => response.json())
        .then(data => {
            displayAlerts(data.alerts);
            updatePagination(data.total_pages, data.current_page);
            totalPages = data.total_pages;
        })
        .catch(error => {
            console.error('Error loading alerts:', error);
            showAlert('Error loading alerts', 'error');
        });
}

function displayAlerts(alerts) {
    const tbody = document.getElementById('alerts-tbody');
    tbody.innerHTML = '';
    
    if (alerts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    No alerts found for the selected criteria
                </td>
            </tr>
        `;
        return;
    }
    
    alerts.forEach(alert => {
        const row = document.createElement('tr');
        row.className = alert.status === 'unread' ? 'table-warning' : '';
        
        const severityBadge = getSeverityBadge(alert.severity);
        const statusBadge = getStatusBadge(alert.status);
        const typeBadge = getTypeBadge(alert.type);
        
        row.innerHTML = `
            <td>
                <small class="text-muted">${formatDateTime(alert.timestamp)}</small>
            </td>
            <td>${typeBadge}</td>
            <td>
                <span class="badge bg-secondary">${alert.symbol || 'N/A'}</span>
            </td>
            <td>
                <div class="text-truncate" style="max-width: 300px;" title="${alert.message}">
                    ${alert.message}
                </div>
            </td>
            <td>${severityBadge}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showAlertDetail('${alert.id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAlert('${alert.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function getSeverityBadge(severity) {
    const badges = {
        'info': '<span class="badge bg-info">Info</span>',
        'warning': '<span class="badge bg-warning">Warning</span>',
        'error': '<span class="badge bg-danger">Error</span>',
        'critical': '<span class="badge bg-dark">Critical</span>'
    };
    return badges[severity] || '<span class="badge bg-secondary">Unknown</span>';
}

function getStatusBadge(status) {
    const badges = {
        'read': '<span class="badge bg-success">Read</span>',
        'unread': '<span class="badge bg-warning">Unread</span>',
        'archived': '<span class="badge bg-secondary">Archived</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function getTypeBadge(type) {
    const badges = {
        'trade_signal': '<span class="badge bg-primary">Trade Signal</span>',
        'position_opened': '<span class="badge bg-success">Position Opened</span>',
        'position_closed': '<span class="badge bg-info">Position Closed</span>',
        'stop_loss': '<span class="badge bg-danger">Stop Loss</span>',
        'take_profit': '<span class="badge bg-success">Take Profit</span>',
        'error': '<span class="badge bg-danger">Error</span>',
        'system': '<span class="badge bg-secondary">System</span>'
    };
    return badges[type] || '<span class="badge bg-secondary">Unknown</span>';
}

function updatePagination(totalPages, currentPage) {
    const pagination = document.getElementById('alerts-pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadAlerts();
}

function loadSummaryStats() {
    fetch('/api/alert_stats')
        .then(response => response.json())
        .then(stats => {
            document.getElementById('total-alerts').textContent = stats.total || 0;
            document.getElementById('trade-signals').textContent = stats.trade_signals || 0;
            document.getElementById('warning-alerts').textContent = stats.warnings || 0;
            document.getElementById('error-alerts').textContent = stats.errors || 0;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function showAlertDetail(alertId) {
    fetch(`/api/alert/${alertId}`)
        .then(response => response.json())
        .then(alert => {
            document.getElementById('modal-alert-id').textContent = alert.id;
            document.getElementById('modal-timestamp').textContent = formatDateTime(alert.timestamp);
            document.getElementById('modal-type').innerHTML = getTypeBadge(alert.type);
            document.getElementById('modal-symbol').textContent = alert.symbol || 'N/A';
            document.getElementById('modal-severity').innerHTML = getSeverityBadge(alert.severity);
            document.getElementById('modal-status').innerHTML = getStatusBadge(alert.status);
            document.getElementById('modal-message').textContent = alert.message;
            
            // Show trade details if available
            if (alert.trade_details) {
                document.getElementById('modal-trade-details').style.display = 'block';
                const tradeTable = document.getElementById('modal-trade-table');
                tradeTable.innerHTML = '';
                
                Object.entries(alert.trade_details).forEach(([key, value]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${key.replace('_', ' ').toUpperCase()}:</strong></td>
                        <td>${value}</td>
                    `;
                    tradeTable.appendChild(row);
                });
            } else {
                document.getElementById('modal-trade-details').style.display = 'none';
            }
            
            new bootstrap.Modal(document.getElementById('alertDetailModal')).show();
        })
        .catch(error => {
            console.error('Error loading alert details:', error);
            showAlert('Error loading alert details', 'error');
        });
}

function markAsRead() {
    const alertId = document.getElementById('modal-alert-id').textContent;
    
    fetch(`/api/alert/${alertId}/mark_read`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('Alert marked as read', 'success');
            loadAlerts();
            bootstrap.Modal.getInstance(document.getElementById('alertDetailModal')).hide();
        }
    })
    .catch(error => {
        console.error('Error marking alert as read:', error);
        showAlert('Error updating alert', 'error');
    });
}

function deleteAlert(alertId) {
    if (!confirm('Are you sure you want to delete this alert?')) return;
    
    fetch(`/api/alert/${alertId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('Alert deleted successfully', 'success');
            loadAlerts();
            loadSummaryStats();
        }
    })
    .catch(error => {
        console.error('Error deleting alert:', error);
        showAlert('Error deleting alert', 'error');
    });
}

function exportAlerts() {
    const params = new URLSearchParams(currentFilters);
    params.set('export', 'true');
    
    window.open(`/api/alerts?${params.toString()}`, '_blank');
}

function clearAlerts() {
    if (!confirm('Are you sure you want to clear all alerts? This action cannot be undone.')) return;
    
    fetch('/api/alerts/clear', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('All alerts cleared successfully', 'success');
            loadAlerts();
            loadSummaryStats();
        }
    })
    .catch(error => {
        console.error('Error clearing alerts:', error);
        showAlert('Error clearing alerts', 'error');
    });
}

function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}