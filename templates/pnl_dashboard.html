<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¯ Bybit PNL Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .metric-card {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }
        .metric-card.negative {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .loading {
            text-align: center;
            padding: 50px;
        }
        .trade-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .refresh-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line"></i> Bybit PNL Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn refresh-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Controls -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5><i class="fas fa-cog"></i> Settings</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="symbolSelect" class="form-label">Symbol:</label>
                            <select class="form-select" id="symbolSelect">
                                <option value="ETHUSDT">ETHUSDT</option>
                                <option value="BTCUSDT">BTCUSDT</option>
                                <option value="ADAUSDT">ADAUSDT</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="daysSelect" class="form-label">Period:</label>
                            <select class="form-select" id="daysSelect">
                                <option value="7">7 Days</option>
                                <option value="30" selected>30 Days</option>
                                <option value="90">90 Days</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5><i class="fas fa-wallet"></i> Account Info</h5>
                    <div id="accountInfo">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PNL Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5><i class="fas fa-chart-bar"></i> PNL Summary</h5>
                    <div id="pnlSummary" class="row">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading PNL data...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PNL Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5><i class="fas fa-chart-line"></i> PNL Performance Chart</h5>
                    <div id="pnlChart">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading chart...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade History -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5><i class="fas fa-history"></i> Recent Trades</h5>
                    <div class="trade-table">
                        <div id="tradeHistory">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading trades...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        // Initialize dashboard
        $(document).ready(function() {
            loadDashboardData();
            loadAccountInfo();
            
            // Event listeners
            $('#symbolSelect, #daysSelect').change(function() {
                loadDashboardData();
            });
        });

        function refreshData() {
            loadDashboardData();
            loadAccountInfo();
        }

        function loadAccountInfo() {
            $.get('/api/account-info')
                .done(function(response) {
                    if (response.success && response.balance.success) {
                        const balance = response.balance;
                        $('#accountInfo').html(`
                            <div class="row">
                                <div class="col-6">
                                    <strong>Total Balance:</strong><br>
                                    $${balance.total_balance.toFixed(2)}
                                </div>
                                <div class="col-6">
                                    <strong>Available:</strong><br>
                                    $${balance.available_balance.toFixed(2)}
                                </div>
                            </div>
                        `);
                    } else {
                        $('#accountInfo').html('<div class="text-warning">Failed to load account info</div>');
                    }
                })
                .fail(function() {
                    $('#accountInfo').html('<div class="text-danger">Error loading account info</div>');
                });
        }

        function loadDashboardData() {
            const symbol = $('#symbolSelect').val();
            const days = $('#daysSelect').val();
            
            // Show loading
            $('#pnlSummary').html('<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
            $('#tradeHistory').html('<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
            
            $.get('/api/dashboard-data', { symbol: symbol, days: days })
                .done(function(response) {
                    if (response.success) {
                        currentData = response.data;
                        displayPnLSummary(response.data.pnl_summary);
                        displayTradeHistory(response.data.trades);
                        loadPnLChart(symbol, days);
                    } else {
                        $('#pnlSummary').html('<div class="text-danger">Error: ' + response.error + '</div>');
                    }
                })
                .fail(function() {
                    $('#pnlSummary').html('<div class="text-danger">Failed to load data</div>');
                });
        }

        function displayPnLSummary(pnlData) {
            const isProfit = pnlData.net_pnl >= 0;
            const winRateClass = pnlData.win_rate >= 50 ? '' : 'negative';
            
            $('#pnlSummary').html(`
                <div class="col-md-2">
                    <div class="metric-card ${isProfit ? '' : 'negative'}">
                        <div class="metric-value">$${pnlData.net_pnl.toFixed(4)}</div>
                        <div class="metric-label">Net PNL</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card">
                        <div class="metric-value">${pnlData.total_trades}</div>
                        <div class="metric-label">Total Trades</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card ${winRateClass}">
                        <div class="metric-value">${pnlData.win_rate.toFixed(1)}%</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card">
                        <div class="metric-value">${pnlData.winning_trades}</div>
                        <div class="metric-label">Wins</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card negative">
                        <div class="metric-value">${pnlData.losing_trades}</div>
                        <div class="metric-label">Losses</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card negative">
                        <div class="metric-value">$${pnlData.total_fees.toFixed(4)}</div>
                        <div class="metric-label">Total Fees</div>
                    </div>
                </div>
            `);
        }

        function displayTradeHistory(trades) {
            if (trades.length === 0) {
                $('#tradeHistory').html('<div class="text-warning">No trades found</div>');
                return;
            }

            let html = `
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Side</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Value</th>
                            <th>PNL</th>
                            <th>Fee</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            trades.slice(0, 50).forEach(trade => {
                const pnlClass = trade['Closed PNL'] >= 0 ? 'text-success' : 'text-danger';
                const sideClass = trade.Side === 'Buy' ? 'text-success' : 'text-danger';
                
                html += `
                    <tr>
                        <td>${trade.Timestamp}</td>
                        <td class="${sideClass}">${trade.Side}</td>
                        <td>${trade.Quantity}</td>
                        <td>$${trade.Price.toFixed(2)}</td>
                        <td>$${trade['Value (USDT)'].toFixed(2)}</td>
                        <td class="${pnlClass}">$${trade['Closed PNL'].toFixed(4)}</td>
                        <td>$${trade['Fee (USDT)'].toFixed(4)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            $('#tradeHistory').html(html);
        }

        function loadPnLChart(symbol, days) {
            $('#pnlChart').html('<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading chart...</div>');
            
            $.get('/api/pnl-chart', { symbol: symbol, days: days })
                .done(function(response) {
                    if (response.success) {
                        const chartData = JSON.parse(response.chart);
                        Plotly.newPlot('pnlChart', chartData.data, chartData.layout, {responsive: true});
                    } else {
                        $('#pnlChart').html('<div class="text-danger">Error loading chart: ' + response.error + '</div>');
                    }
                })
                .fail(function() {
                    $('#pnlChart').html('<div class="text-danger">Failed to load chart</div>');
                });
        }
    </script>
</body>
</html>